<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/ebusiness/ebiz/QuestionsActivityNew.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/ebusiness/ebiz/QuestionsActivityNew.java" />
              <option name="updatedContent" value="package com.ebusiness.ebiz;&#10;&#10;import android.content.Intent;&#10;import android.os.Bundle;&#10;import android.text.Editable;&#10;import android.text.TextWatcher;&#10;import android.util.Log;&#10;import android.view.View;&#10;import android.widget.Button;&#10;import android.widget.EditText;&#10;import android.widget.LinearLayout;&#10;import android.widget.TextView;&#10;import android.widget.Toast;&#10;import androidx.appcompat.app.AppCompatActivity;&#10;&#10;import java.io.IOException;&#10;import java.util.ArrayList;&#10;import java.util.HashMap;&#10;import java.util.List;&#10;import java.util.Map;&#10;import java.util.concurrent.TimeUnit;&#10;&#10;import okhttp3.Call;&#10;import okhttp3.Callback;&#10;import okhttp3.MediaType;&#10;import okhttp3.OkHttpClient;&#10;import okhttp3.Request;&#10;import okhttp3.RequestBody;&#10;import okhttp3.Response;&#10;import org.json.JSONArray;&#10;import org.json.JSONException;&#10;import org.json.JSONObject;&#10;&#10;/**&#10; * AI 구체화 질문 화면&#10; * 더 정확한 리스크 분석을 위한 추가 질문들을 표시하고 답변을 수집하는 화면&#10; */&#10;public class QuestionsActivity extends AppCompatActivity {&#10;    private static final String TAG = &quot;QuestionsActivity&quot;;&#10;&#10;    // Backend API Configuration&#10;    private static final String BASE_URL = &quot;https://ebizapi.zeabur.app&quot;;&#10;    private static final String QUESTIONS_ENDPOINT = &quot;/api/v1/analyze/questions&quot;;&#10;    private static final MediaType JSON = MediaType.get(&quot;application/json; charset=utf-8&quot;);&#10;&#10;    // HTTP Client&#10;    private OkHttpClient httpClient;&#10;&#10;    // Session data from previous activity&#10;    private String sessionId;&#10;&#10;    // UI Components&#10;    private LinearLayout questionsContainer;&#10;    private Button btnPrevious;&#10;    private Button btnSubmit;&#10;&#10;    // Data&#10;    private List&lt;Question&gt; questions;&#10;    private Map&lt;String, String&gt; answers;&#10;&#10;    @Override&#10;    protected void onCreate(Bundle savedInstanceState) {&#10;        super.onCreate(savedInstanceState);&#10;        setContentView(R.layout.activity_questions);&#10;&#10;        initializeHttpClient();&#10;        initializeViews();&#10;        setupClickListeners();&#10;        extractSessionData();&#10;        &#10;        // 만약 질문 데이터가 없다면 API에서 가져오기&#10;        if (questions == null || questions.isEmpty()) {&#10;            loadQuestionsFromApi();&#10;        }&#10;    }&#10;&#10;    private void initializeHttpClient() {&#10;        httpClient = new OkHttpClient.Builder()&#10;                .connectTimeout(30, TimeUnit.SECONDS)&#10;                .readTimeout(30, TimeUnit.SECONDS)&#10;                .writeTimeout(30, TimeUnit.SECONDS)&#10;                .build();&#10;    }&#10;&#10;    private void initializeViews() {&#10;        questionsContainer = findViewById(R.id.questionsContainer);&#10;        btnPrevious = findViewById(R.id.btnPrevious);&#10;        btnSubmit = findViewById(R.id.btnSubmit);&#10;        &#10;        // 답변 저장용 맵 초기화&#10;        answers = new HashMap&lt;&gt;();&#10;    }&#10;&#10;    private void extractSessionData() {&#10;        Intent intent = getIntent();&#10;        sessionId = intent.getStringExtra(&quot;session_id&quot;);&#10;        String questionsResponse = intent.getStringExtra(&quot;questions_response&quot;);&#10;&#10;        if (sessionId == null || sessionId.isEmpty()) {&#10;            Log.e(TAG, &quot;No session_id provided&quot;);&#10;            Toast.makeText(this, &quot;세션 정보가 없습니다. 다시 시도해주세요.&quot;, Toast.LENGTH_LONG).show();&#10;            finish();&#10;            return;&#10;        }&#10;&#10;        // 만약 질문 데이터가 이미 있다면 바로 사용, 없다면 API 호출&#10;        if (questionsResponse != null &amp;&amp; !questionsResponse.isEmpty()) {&#10;            Log.d(TAG, &quot;Using provided questions response: &quot; + questionsResponse);&#10;            handleQuestionsApiSuccess(questionsResponse);&#10;        }&#10;    }&#10;    &#10;    private void setupClickListeners() {&#10;        // 이전 버튼&#10;        btnPrevious.setOnClickListener(v -&gt; finish());&#10;&#10;        // 제출 버튼&#10;        btnSubmit.setOnClickListener(v -&gt; {&#10;            if (validateAnswers()) {&#10;                submitAnswers();&#10;            }&#10;        });&#10;    }&#10;&#10;    private void loadQuestionsFromApi() {&#10;        // 로딩 상태 표시&#10;        showLoadingState();&#10;&#10;        try {&#10;            // JSON 요청 바디 생성&#10;            JSONObject requestBody = new JSONObject();&#10;            requestBody.put(&quot;session_id&quot;, sessionId);&#10;&#10;            RequestBody body = RequestBody.create(requestBody.toString(), JSON);&#10;            String fullUrl = BASE_URL + QUESTIONS_ENDPOINT;&#10;&#10;            Request request = new Request.Builder()&#10;                    .url(fullUrl)&#10;                    .post(body)&#10;                    .addHeader(&quot;Content-Type&quot;, &quot;application/json&quot;)&#10;                    .addHeader(&quot;Accept&quot;, &quot;application/json&quot;)&#10;                    .addHeader(&quot;User-Agent&quot;, &quot;RiskManager-Android/1.0&quot;)&#10;                    .build();&#10;&#10;            Log.d(TAG, &quot;Requesting questions from: &quot; + fullUrl);&#10;            Log.d(TAG, &quot;Request body: &quot; + requestBody);&#10;&#10;            httpClient.newCall(request).enqueue(new Callback() {&#10;                @Override&#10;                public void onFailure(Call call, IOException e) {&#10;                    Log.e(TAG, &quot;Questions API request failed&quot;, e);&#10;                    runOnUiThread(() -&gt; handleQuestionsApiError(&quot;네트워크 오류가 발생했습니다. 다시 시도해주세요.&quot;));&#10;                }&#10;&#10;                @Override&#10;                public void onResponse(Call call, Response response) throws IOException {&#10;                    String responseBody = response.body() != null ? response.body().string() : &quot;&quot;;&#10;&#10;                    if (response.isSuccessful()) {&#10;                        Log.d(TAG, &quot;Questions API response success: &quot; + responseBody);&#10;                        runOnUiThread(() -&gt; handleQuestionsApiSuccess(responseBody));&#10;                    } else {&#10;                        Log.e(TAG, &quot;Questions API failed with code: &quot; + response.code() + &quot;, response: &quot; + responseBody);&#10;                        runOnUiThread(() -&gt; handleQuestionsApiError(&quot;서버에서 질문을 가져오는데 실패했습니다. (코드: &quot; + response.code() + &quot;)&quot;));&#10;                    }&#10;                }&#10;            });&#10;&#10;        } catch (JSONException e) {&#10;            Log.e(TAG, &quot;JSON creation error&quot;, e);&#10;            handleQuestionsApiError(&quot;요청 데이터 생성 중 오류가 발생했습니다.&quot;);&#10;        }&#10;    }&#10;&#10;    private void showLoadingState() {&#10;        // 기존 질문 컨테이너 숨기기&#10;        questionsContainer.removeAllViews();&#10;&#10;        // 로딩 메시지 표시&#10;        TextView loadingText = new TextView(this);&#10;        loadingText.setText(&quot;AI가 맞춤형 질문을 생성하고 있습니다...&quot;);&#10;        loadingText.setTextSize(16);&#10;        loadingText.setTextColor(getColor(R.color.text_secondary));&#10;        loadingText.setGravity(android.view.Gravity.CENTER);&#10;        loadingText.setPadding(20, 40, 20, 40);&#10;&#10;        questionsContainer.addView(loadingText);&#10;&#10;        // 버튼 비활성화&#10;        btnSubmit.setEnabled(false);&#10;    }&#10;&#10;    private void handleQuestionsApiSuccess(String responseBody) {&#10;        try {&#10;            JSONObject response = new JSONObject(responseBody);&#10;&#10;            // 응답에서 질문 데이터 추출&#10;            JSONArray questionsArray = response.getJSONArray(&quot;questions&quot;);&#10;            int totalQuestions = response.getInt(&quot;total_questions&quot;);&#10;&#10;            Log.d(TAG, &quot;Total questions received: &quot; + totalQuestions);&#10;&#10;            // 질문 리스트 생성&#10;            questions = new ArrayList&lt;&gt;();&#10;            for (int i = 0; i &lt; questionsArray.length(); i++) {&#10;                JSONObject questionObj = questionsArray.getJSONObject(i);&#10;&#10;                String questionId = questionObj.getString(&quot;question_id&quot;);&#10;                String method = questionObj.getString(&quot;method&quot;);&#10;                String questionText = questionObj.getString(&quot;question_text&quot;);&#10;                String questionType = questionObj.optString(&quot;question_type&quot;, &quot;text&quot;);&#10;&#10;                // choices 배열 처리 (현재는 사용하지 않지만 향후 확장용)&#10;                List&lt;String&gt; choices = new ArrayList&lt;&gt;();&#10;                if (questionObj.has(&quot;choices&quot;)) {&#10;                    JSONArray choicesArray = questionObj.getJSONArray(&quot;choices&quot;);&#10;                    for (int j = 0; j &lt; choicesArray.length(); j++) {&#10;                        choices.add(choicesArray.getString(j));&#10;                    }&#10;                }&#10;&#10;                questions.add(new Question(questionId, method, questionText, questionType, choices));&#10;            }&#10;&#10;            // UI 업데이트&#10;            renderQuestions();&#10;            checkFormValidity();&#10;&#10;        } catch (JSONException e) {&#10;            Log.e(TAG, &quot;Questions response parsing error&quot;, e);&#10;            handleQuestionsApiError(&quot;질문 데이터 처리 중 오류가 발생했습니다.&quot;);&#10;        }&#10;    }&#10;&#10;    private void handleQuestionsApiError(String errorMessage) {&#10;        Toast.makeText(this, errorMessage, Toast.LENGTH_LONG).show();&#10;        Log.e(TAG, &quot;Questions API Error: &quot; + errorMessage);&#10;&#10;        // 오류 발생 시 이전 화면으로 돌아가기&#10;        finish();&#10;    }&#10;&#10;    private void renderQuestions() {&#10;        questionsContainer.removeAllViews();&#10;&#10;        for (int i = 0; i &lt; questions.size(); i++) {&#10;            Question question = questions.get(i);&#10;            View questionCard = createQuestionCard(question, i + 1);&#10;            questionsContainer.addView(questionCard);&#10;        }&#10;    }&#10;&#10;    private View createQuestionCard(Question question, int questionNumber) {&#10;        // question card container&#10;        LinearLayout cardContainer = new LinearLayout(this);&#10;        cardContainer.setOrientation(LinearLayout.VERTICAL);&#10;        cardContainer.setBackgroundResource(R.drawable.question_card_background);&#10;&#10;        LinearLayout.LayoutParams cardParams = new LinearLayout.LayoutParams(&#10;            LinearLayout.LayoutParams.MATCH_PARENT,&#10;            LinearLayout.LayoutParams.WRAP_CONTENT&#10;        );&#10;        cardParams.setMargins(0, 0, 0, dpToPx(16));&#10;        cardContainer.setLayoutParams(cardParams);&#10;        cardContainer.setPadding(dpToPx(21), dpToPx(21), dpToPx(21), dpToPx(21));&#10;&#10;        // Question header&#10;        LinearLayout questionHeader = new LinearLayout(this);&#10;        questionHeader.setOrientation(LinearLayout.HORIZONTAL);&#10;        questionHeader.setLayoutParams(new LinearLayout.LayoutParams(&#10;            LinearLayout.LayoutParams.MATCH_PARENT,&#10;            LinearLayout.LayoutParams.WRAP_CONTENT&#10;        ));&#10;&#10;        // Question number&#10;        TextView questionNum = new TextView(this);&#10;        questionNum.setText(&quot;Q&quot; + questionNumber + &quot;.&quot;);&#10;        questionNum.setTextSize(16);&#10;        questionNum.setTextColor(getColor(R.color.button_enabled));&#10;        LinearLayout.LayoutParams numParams = new LinearLayout.LayoutParams(&#10;            LinearLayout.LayoutParams.WRAP_CONTENT,&#10;            LinearLayout.LayoutParams.WRAP_CONTENT&#10;        );&#10;        numParams.setMarginEnd(dpToPx(7));&#10;        questionNum.setLayoutParams(numParams);&#10;&#10;        // Question text&#10;        TextView questionTextView = new TextView(this);&#10;        questionTextView.setId(View.generateViewId());&#10;        questionTextView.setText(question.questionText);&#10;        questionTextView.setTextSize(14);&#10;        questionTextView.setTextColor(getColor(R.color.text_primary));&#10;        questionTextView.setLayoutParams(new LinearLayout.LayoutParams(&#10;            LinearLayout.LayoutParams.MATCH_PARENT,&#10;            LinearLayout.LayoutParams.WRAP_CONTENT&#10;        ));&#10;&#10;        questionHeader.addView(questionNum);&#10;        questionHeader.addView(questionTextView);&#10;&#10;        // Input field&#10;        EditText inputField = new EditText(this);&#10;        inputField.setId(View.generateViewId());&#10;        inputField.setHint(&quot;답변을 입력하세요...&quot;);&#10;        inputField.setTextSize(14);&#10;        inputField.setTextColor(getColor(R.color.text_primary));&#10;        inputField.setHintTextColor(getColor(R.color.input_hint_color));&#10;        inputField.setBackgroundResource(R.drawable.question_input_background);&#10;        inputField.setSingleLine(false);&#10;        inputField.setMaxLines(5);&#10;        inputField.setMinLines(1);&#10;&#10;        LinearLayout.LayoutParams inputParams = new LinearLayout.LayoutParams(&#10;            LinearLayout.LayoutParams.MATCH_PARENT,&#10;            LinearLayout.LayoutParams.WRAP_CONTENT&#10;        );&#10;        inputParams.setMargins(0, dpToPx(15), 0, 0);&#10;        inputField.setLayoutParams(inputParams);&#10;        inputField.setPadding(dpToPx(13), dpToPx(13), dpToPx(13), dpToPx(13));&#10;&#10;        // Text watcher for answer validation&#10;        inputField.addTextChangedListener(new TextWatcher() {&#10;            @Override&#10;            public void beforeTextChanged(CharSequence s, int start, int count, int after) {}&#10;&#10;            @Override&#10;            public void onTextChanged(CharSequence s, int start, int before, int count) {}&#10;&#10;            @Override&#10;            public void afterTextChanged(Editable s) {&#10;                answers.put(question.questionId, s.toString().trim());&#10;                checkFormValidity();&#10;            }&#10;        });&#10;&#10;        cardContainer.addView(questionHeader);&#10;        cardContainer.addView(inputField);&#10;&#10;        return cardContainer;&#10;    }&#10;&#10;    private void checkFormValidity() {&#10;        if (questions == null || questions.isEmpty()) return;&#10;        &#10;        boolean allAnswered = true;&#10;        for (Question question : questions) {&#10;            String answer = answers.get(question.questionId);&#10;            if (answer == null || answer.isEmpty()) {&#10;                allAnswered = false;&#10;                break;&#10;            }&#10;        }&#10;&#10;        btnSubmit.setEnabled(allAnswered);&#10;    }&#10;&#10;    private boolean validateAnswers() {&#10;        for (Question question : questions) {&#10;            String answer = answers.get(question.questionId);&#10;            if (answer == null || answer.trim().isEmpty()) {&#10;                Toast.makeText(this, &quot;모든 질문에 답변해주세요&quot;, Toast.LENGTH_SHORT).show();&#10;                return false;&#10;            }&#10;        }&#10;        return true;&#10;    }&#10;&#10;    private void submitAnswers() {&#10;        Toast.makeText(this, &quot;답변을 제출하고 있습니다...&quot;, Toast.LENGTH_SHORT).show();&#10;&#10;        // 버튼 비활성화 및 로딩 상태 표시&#10;        btnSubmit.setEnabled(false);&#10;        btnSubmit.setText(&quot;답변 제출 중...&quot;);&#10;&#10;        try {&#10;            // JSON 요청 바디 생성&#10;            JSONObject requestBody = new JSONObject();&#10;            requestBody.put(&quot;session_id&quot;, sessionId);&#10;            &#10;            // 답변 데이터 전달&#10;            JSONArray answersArray = new JSONArray();&#10;            for (Question question : questions) {&#10;                JSONObject answerObj = new JSONObject();&#10;                answerObj.put(&quot;question_id&quot;, question.questionId);&#10;                answerObj.put(&quot;answer&quot;, answers.get(question.questionId));&#10;                answersArray.put(answerObj);&#10;            }&#10;            requestBody.put(&quot;answers&quot;, answersArray);&#10;&#10;            RequestBody body = RequestBody.create(requestBody.toString(), JSON);&#10;            String fullUrl = BASE_URL + &quot;/api/v1/analyze/submit&quot;;&#10;&#10;            Request request = new Request.Builder()&#10;                    .url(fullUrl)&#10;                    .post(body)&#10;                    .addHeader(&quot;Content-Type&quot;, &quot;application/json&quot;)&#10;                    .addHeader(&quot;Accept&quot;, &quot;application/json&quot;)&#10;                    .addHeader(&quot;User-Agent&quot;, &quot;RiskManager-Android/1.0&quot;)&#10;                    .build();&#10;&#10;            Log.d(TAG, &quot;Submitting answers to: &quot; + fullUrl);&#10;            Log.d(TAG, &quot;Request body: &quot; + requestBody);&#10;&#10;            httpClient.newCall(request).enqueue(new Callback() {&#10;                @Override&#10;                public void onFailure(Call call, IOException e) {&#10;                    Log.e(TAG, &quot;Submit answers API request failed&quot;, e);&#10;                    runOnUiThread(() -&gt; handleSubmitAnswersError(&quot;네트워크 오류가 발생했습니다. 다시 시도해주세요.&quot;));&#10;                }&#10;&#10;                @Override&#10;                public void onResponse(Call call, Response response) throws IOException {&#10;                    String responseBody = response.body() != null ? response.body().string() : &quot;&quot;;&#10;&#10;                    if (response.isSuccessful()) {&#10;                        Log.d(TAG, &quot;Submit answers API response success: &quot; + responseBody);&#10;                        runOnUiThread(() -&gt; handleSubmitAnswersSuccess(responseBody));&#10;                    } else {&#10;                        Log.e(TAG, &quot;Submit answers API failed with code: &quot; + response.code() + &quot;, response: &quot; + responseBody);&#10;                        runOnUiThread(() -&gt; handleSubmitAnswersError(&quot;서버에서 답변 처리에 실패했습니다. (코드: &quot; + response.code() + &quot;)&quot;));&#10;                    }&#10;                }&#10;            });&#10;&#10;        } catch (JSONException e) {&#10;            Log.e(TAG, &quot;JSON creation error&quot;, e);&#10;            handleSubmitAnswersError(&quot;요청 데이터 생성 중 오류가 발생했습니다.&quot;);&#10;        }&#10;    }&#10;&#10;    private void handleSubmitAnswersSuccess(String responseBody) {&#10;        try {&#10;            JSONObject response = new JSONObject(responseBody);&#10;            Log.d(TAG, &quot;Answers submitted successfully: &quot; + responseBody);&#10;            &#10;            Toast.makeText(this, &quot;답변이 성공적으로 제출되었습니다!&quot;, Toast.LENGTH_SHORT).show();&#10;            &#10;            // ReportActivity로 이동 (분석 결과 화면)&#10;            Intent intent = new Intent(this, ReportActivity.class);&#10;            intent.putExtra(&quot;session_id&quot;, sessionId);&#10;            intent.putExtra(&quot;project_title&quot;, getIntent().getStringExtra(&quot;project_title&quot;));&#10;            intent.putExtra(&quot;project_description&quot;, getIntent().getStringExtra(&quot;project_description&quot;));&#10;            intent.putExtra(&quot;project_budget&quot;, getIntent().getStringExtra(&quot;project_budget&quot;));&#10;            &#10;            startActivity(intent);&#10;            finish();&#10;            &#10;        } catch (JSONException e) {&#10;            Log.e(TAG, &quot;Submit answers response parsing error&quot;, e);&#10;            handleSubmitAnswersError(&quot;답변 제출 결과 처리 중 오류가 발생했습니다.&quot;);&#10;        }&#10;    }&#10;    &#10;    private void handleSubmitAnswersError(String errorMessage) {&#10;        Toast.makeText(this, errorMessage, Toast.LENGTH_LONG).show();&#10;        Log.e(TAG, &quot;Submit answers Error: &quot; + errorMessage);&#10;        &#10;        // 버튼 상태 복원&#10;        btnSubmit.setEnabled(true);&#10;        btnSubmit.setText(&quot;최종 분석 시작&quot;);&#10;    }&#10;    &#10;    // dp를 px로 변환하는 유틸리티 메서드&#10;    private int dpToPx(int dp) {&#10;        return (int) (dp * getResources().getDisplayMetrics().density);&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>